<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{% block title %}Generador de cuentos ilustrados{% endblock %}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/app.css') }}">
</head>
<body>
  <header class="site-header">
    <div class="container row between center">
      <a class="brand" href="{{ url_for('web.dashboard') }}">Generador de cuentos ilustrados</a>
      <small class="muted">Biblioteca canónica + caché temporal</small>
    </div>
  </header>

  <main class="container">
    {% if cache_status and cache_status.stale %}
      <section class="flash-stack">
        <div class="flash error">
          <strong>Caché desactualizada.</strong>
          Cambió `biblioteca/` desde el último refresco.
          <form method="post" action="{{ url_for('web.cache_refresh') }}" class="inline-form">
            <input type="hidden" name="next" value="{{ request.full_path if request else '/' }}">
            <button type="submit">Actualizar caché</button>
          </form>
        </div>
      </section>
    {% endif %}

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <section class="flash-stack">
          {% for category, message in messages %}
            <div class="flash {{ category }}">{{ message }}</div>
          {% endfor %}
        </section>
      {% endif %}
    {% endwith %}

    {% block content %}{% endblock %}
  </main>

  <script>
    async function copyTextFromElement(id, feedbackId) {
      const el = document.getElementById(id);
      if (!el) return;
      const text = el.innerText || el.value || "";
      const feedback = document.getElementById(feedbackId);
      try {
        if (navigator.clipboard && window.isSecureContext) {
          await navigator.clipboard.writeText(text);
        } else {
          const ta = document.createElement("textarea");
          ta.value = text;
          document.body.appendChild(ta);
          ta.select();
          document.execCommand("copy");
          ta.remove();
        }
        if (feedback) {
          feedback.textContent = "Copiado";
          setTimeout(() => { feedback.textContent = ""; }, 1200);
        }
      } catch (err) {
        if (feedback) {
          feedback.textContent = "Error al copiar";
          setTimeout(() => { feedback.textContent = ""; }, 1600);
        }
      }
    }

    async function copyImageFromUrl(url, feedbackId) {
      const feedback = document.getElementById(feedbackId);
      try {
        const res = await fetch(url, { cache: "no-store" });
        const blob = await res.blob();
        if (!blob.type.startsWith("image/")) {
          throw new Error("El archivo no es una imagen");
        }
        if (!navigator.clipboard || !window.ClipboardItem) {
          throw new Error("Portapapeles de imagen no disponible");
        }
        await navigator.clipboard.write([new ClipboardItem({ [blob.type]: blob })]);
        if (feedback) {
          feedback.textContent = "Imagen copiada";
          setTimeout(() => { feedback.textContent = ""; }, 1200);
        }
      } catch (err) {
        if (feedback) {
          feedback.textContent = "No se pudo copiar; abre la imagen y copia manualmente";
          setTimeout(() => { feedback.textContent = ""; }, 2500);
        }
      }
    }

    async function pasteImageToHidden(inputId, feedbackId) {
      const input = document.getElementById(inputId);
      const feedback = document.getElementById(feedbackId);
      if (!input) return;
      if (!navigator.clipboard || !navigator.clipboard.read) {
        if (feedback) {
          feedback.textContent = "El navegador no soporta pegar imagen";
        }
        return;
      }
      try {
        const items = await navigator.clipboard.read();
        for (const item of items) {
          const type = item.types.find(t => t.startsWith("image/"));
          if (!type) continue;
          const blob = await item.getType(type);
          const reader = new FileReader();
          reader.onload = () => {
            input.value = String(reader.result || "");
            if (feedback) {
              feedback.textContent = "Imagen pegada y lista para guardar";
              setTimeout(() => { feedback.textContent = ""; }, 1600);
            }
          };
          reader.readAsDataURL(blob);
          return;
        }
        if (feedback) {
          feedback.textContent = "No se detectó imagen en el portapapeles";
          setTimeout(() => { feedback.textContent = ""; }, 1800);
        }
      } catch (err) {
        if (feedback) {
          feedback.textContent = "No se pudo leer el portapapeles";
          setTimeout(() => { feedback.textContent = ""; }, 1800);
        }
      }
    }
  </script>
</body>
</html>