{% extends "layouts/base.html" %}
{% block title %}{{ story.title }} | Editor de portada{% endblock %}
{% block content %}
  {% include "components/breadcrumbs.html" %}

  <section class="box hero-surface">
    <div class="is-flex is-justify-content-space-between is-align-items-flex-start is-flex-wrap-wrap gap-3">
      <div>
        <h1 class="title is-3 mb-2">{{ story.title }}</h1>
        <p class="has-text-grey mb-1">Ruta: <code>{{ story.story_rel_path }}</code></p>
        <p class="has-text-grey mb-1">Libro: <code>{{ story.book_rel_path }}</code></p>
        <p class="has-text-grey">Estado: <strong>{{ story.status }}</strong></p>
      </div>
      <div class="buttons are-small">
        <a class="button is-light" href="{{ url_for('web.node_or_story', path_rel=story.story_rel_path) }}">Modo lectura</a>
        <a class="button is-light" href="{{ url_for('web.node_or_story', path_rel=story.story_rel_path, p=selected_page, editor=1) }}">Editor de pagina</a>
      </div>
    </div>
  </section>

  {% include "components/story/page_nav.html" %}

  <section class="box editor-slot-card">
    <div class="is-flex is-justify-content-space-between is-align-items-center is-flex-wrap-wrap gap-2 mb-3">
      <h3 class="title is-5 mb-0">Portada</h3>
      <span class="tag is-rounded">Estado: {{ cover_slot.status }}</span>
    </div>

    <form method="post" action="{{ url_for('web.save_story_cover', story_path=story.story_rel_path) }}" class="is-flex is-flex-direction-column gap-2">
      <input type="hidden" name="next" value="{{ request.full_path }}">
      <div>
        <label class="label is-size-7">Prompt portada</label>
        <textarea class="textarea is-small" name="cover_prompt" rows="7">{{ cover_slot.prompt }}</textarea>
      </div>
      <div>
        <label class="label is-size-7">Reference IDs portada (csv)</label>
        <input class="input is-small" type="text" name="cover_reference_ids" value="{{ cover_slot.reference_ids_csv }}" placeholder="archivo1.png, archivo2.jpg">
      </div>
      <button class="button is-small is-link" type="submit">Guardar portada</button>
    </form>

    <p class="panel-label mt-4">Referencias del prompt</p>
    {% if cover_slot.reference_assets %}
      <div class="advanced-alt-grid">
        {% for ref in cover_slot.reference_assets %}
          {% set ref_index = loop.index %}
          <article class="alt-card">
            <p class="is-size-7 mb-1"><strong>Archivo:</strong> <code>{{ ref.filename }}</code></p>
            {% if ref.found %}
              <p class="is-size-7 mb-2"><strong>Nodo:</strong> <code>{{ ref.node_rel_path or 'library' }}</code></p>
              <img src="{{ ref.image_url }}" alt="Referencia portada {{ ref.filename }}">
              <div class="is-flex is-align-items-center gap-2 mt-2">
                <button class="button is-small is-light" type="button" onclick="copyImageFromUrl('{{ ref.image_url }}','copy-cover-ref-{{ ref_index }}')">Copiar imagen</button>
                <span id="copy-cover-ref-{{ ref_index }}" class="copy-feedback"></span>
              </div>
            {% else %}
              <p class="has-text-danger is-size-7">Referencia no encontrada.</p>
            {% endif %}
          </article>
        {% endfor %}
      </div>
    {% else %}
      <p class="has-text-grey is-size-7">Sin reference_ids en portada.</p>
    {% endif %}

    {% if cover_slot.active_item and cover_slot.active_item.image_exists %}
      <p class="panel-label mt-4">Portada activa</p>
      <img class="editor-slot-image" src="{{ cover_slot.active_item.image_url }}" alt="Portada activa">
      <div class="is-flex is-align-items-center gap-2 mt-2">
        <button class="button is-small is-light" type="button" onclick="copyImageFromUrl('{{ cover_slot.active_item.image_url }}','copy-cover-active')">Copiar portada</button>
        <span id="copy-cover-active" class="copy-feedback"></span>
      </div>
    {% else %}
      <p class="has-text-grey is-size-7 mt-4">Sin portada activa.</p>
    {% endif %}

    <p class="panel-label mt-4">Alternativas de portada</p>
    {% if cover_slot.alternatives %}
      <div class="advanced-alt-grid">
        {% for alternative in cover_slot.alternatives %}
          {% set alternative_index = loop.index %}
          <article class="alt-card {% if alternative.is_active %}is-active{% endif %}">
            <p class="is-size-7 mb-1"><strong>ID:</strong> <code>{{ alternative.id }}</code></p>
            <p class="is-size-7 mb-2"><strong>Slug:</strong> {{ alternative.slug }}</p>
            {% if alternative.image_exists %}
              <img src="{{ alternative.image_url }}" alt="Portada alternativa {{ alternative.id }}">
              <div class="is-flex is-align-items-center gap-2 mt-2">
                <button class="button is-small is-light" type="button" onclick="copyImageFromUrl('{{ alternative.image_url }}','copy-cover-alt-{{ alternative_index }}')">Copiar imagen</button>
                <span id="copy-cover-alt-{{ alternative_index }}" class="copy-feedback"></span>
              </div>
            {% else %}
              <p class="has-text-grey is-size-7">Archivo no encontrado.</p>
            {% endif %}

            {% if alternative.is_active %}
              <span class="tag is-success is-light mt-3">Activa</span>
            {% else %}
              <form method="post" action="{{ url_for('web.activate_cover_image', story_path=story.story_rel_path) }}" class="mt-3">
                <input type="hidden" name="next" value="{{ request.full_path }}">
                <input type="hidden" name="alternative_id" value="{{ alternative.id }}">
                <button class="button is-small is-primary is-light" type="submit">Usar como activa</button>
              </form>
            {% endif %}
          </article>
        {% endfor %}
      </div>
    {% else %}
      <p class="has-text-grey is-size-7">Sin alternativas registradas.</p>
    {% endif %}

    <hr>
    <h4 class="title is-6">Subir portada alternativa</h4>
    <form
      method="post"
      action="{{ url_for('web.upload_cover_image', story_path=story.story_rel_path) }}"
      enctype="multipart/form-data"
      class="is-flex is-flex-direction-column gap-2"
    >
      <input type="hidden" name="next" value="{{ request.full_path }}">
      <div>
        <label class="label is-size-7">Archivo</label>
        <input class="input is-small" type="file" name="image_file" accept="image/png,image/jpeg,image/webp,image/gif">
      </div>
      <div>
        <label class="label is-size-7">Slug</label>
        <input class="input is-small" type="text" name="alt_slug" placeholder="cover-editorial">
      </div>
      <div>
        <label class="label is-size-7">Notas</label>
        <textarea class="textarea is-small" name="alt_notes" rows="2" placeholder="Observaciones editoriales"></textarea>
      </div>
      <div>
        <label class="label is-size-7">Pegar desde portapapeles</label>
        <div class="is-flex is-align-items-center gap-2">
          <button class="button is-small is-light" type="button" onclick="pasteImageToHidden('pasted-cover','paste-feedback-cover')">Pegar imagen</button>
          <span id="paste-feedback-cover" class="copy-feedback"></span>
        </div>
        <input id="pasted-cover" type="hidden" name="pasted_image_data" value="">
      </div>
      <button class="button is-small is-link is-light" type="submit">Agregar alternativa</button>
    </form>
  </section>
{% endblock %}
