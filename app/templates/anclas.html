{% extends "base.html" %}
{% block title %}Anclas | {{ saga.nombre }}{% endblock %}
{% block content %}
<nav class="breadcrumbs">
  <a href="{{ url_for('web.dashboard') }}">Panel</a>
  <span>/</span>
  <a href="{{ url_for('web.saga_detail', saga_slug=saga.slug) }}">{{ saga.nombre }}</a>
  <span>/</span>
  <span>Anclas</span>
</nav>

<section class="panel">
  <h1>Anclas de {{ saga.nombre }}</h1>
  <form method="post" action="{{ url_for('web.create_ancla', saga_slug=saga.slug) }}" class="form-grid">
    <label>Nombre<input name="nombre" required></label>
    <label>Slug (opcional)<input name="slug"></label>
    <label>Tipo<input name="tipo" value="personaje"></label>
    <label class="full">Descripcion base<textarea name="descripcion_base" rows="3"></textarea></label>
    <button type="submit">Crear ancla</button>
  </form>
</section>

<section class="panel">
  <h2>Listado de anclas</h2>
  {% if anclas %}
    <div class="cards">
      {% for ancla in anclas %}
        <article class="card">
          <div class="card-head">
            <div>
              <strong>{{ ancla.nombre }}</strong>
              <span class="chip">{{ ancla.tipo }}</span>
            </div>
            <small class="muted"><code>{{ ancla.slug }}</code></small>
          </div>
          <div class="card-body">
            {% if ancla.descripcion_base %}
              <p>{{ ancla.descripcion_base }}</p>
            {% endif %}

            <h4>Crear version</h4>
            <form method="post" action="{{ url_for('web.create_ancla_version', ancla_id=ancla.id) }}" class="form-grid">
              <label>Nombre version<input name="nombre_version" required></label>
              <label>Orden<input name="orden" type="number" value="0"></label>
              <label>Estado<input name="estado" value="activo"></label>
              <label class="full">Descripcion<textarea name="descripcion" rows="3"></textarea></label>
              <button type="submit">Crear version</button>
            </form>

            <h4>Versiones</h4>
            {% if ancla.versiones.count() %}
              {% for version in ancla.versiones %}
                <div class="item-card">
                  <p><strong>{{ version.nombre_version }}</strong> ({{ version.estado }})</p>
                  {% if version.descripcion %}<p class="muted">{{ version.descripcion }}</p>{% endif %}
                  <form method="post" action="{{ url_for('web.create_ancla_image', version_id=version.id) }}" class="form-grid">
                    <label>Ruta relativa<input name="ruta_relativa" placeholder="biblioteca/.../ref.png"></label>
                    <label>Orden<input name="orden" type="number" value="0"></label>
                    <label>Estado<input name="estado" value="activo"></label>
                    <label class="full">Prompt referencia<textarea name="prompt_texto" rows="3"></textarea></label>
                    <label class="full">Requisitos libres<textarea name="requisitos_libres_text" rows="3"></textarea></label>
                    <button type="submit">Anadir imagen referencia</button>
                  </form>

                  {% if version.imagenes.count() %}
                    {% for image in version.imagenes %}
                      <div class="panel">
                        <p><strong>{{ image.id }}</strong> | {{ image.rol }} | {{ image.estado }}</p>
                        <p><code>{{ image.ruta_relativa }}</code></p>
                        {% if image.ruta_relativa %}
                          <img src="{{ url_for('web.media_file', rel_path=image.ruta_relativa) }}" alt="{{ image.id }}">
                          <div class="row gap">
                            <button type="button" onclick="copyImageFromUrl('{{ url_for('web.media_file', rel_path=image.ruta_relativa) }}','copy-ancla-{{ image.id }}')">Copiar imagen al portapapeles</button>
                            <span class="copy-feedback" id="copy-ancla-{{ image.id }}"></span>
                          </div>
                        {% endif %}
                        <form method="post" action="{{ url_for('web.update_imagen', imagen_id=image.id) }}" class="form-grid">
                          <label>Rol<input name="rol" value="{{ image.rol }}"></label>
                          <label>Orden<input name="orden" type="number" value="{{ image.orden }}"></label>
                          <label>Estado<input name="estado" value="{{ image.estado }}"></label>
                          <label class="full">Ruta<input name="ruta_relativa" value="{{ image.ruta_relativa }}"></label>
                          <label class="full">Prompt<textarea name="prompt_texto" rows="3">{{ image.prompt_texto }}</textarea></label>
                          <label class="full">Requisitos libres<textarea name="requisitos_libres_text" rows="3">{{ '\n'.join(image.get_requisitos_libres()) }}</textarea></label>
                          <div class="row gap">
                            <button type="submit">Guardar imagen</button>
                            <button type="submit" formaction="{{ url_for('web.delete_imagen', imagen_id=image.id) }}" class="danger">Eliminar imagen</button>
                          </div>
                        </form>
                      </div>
                    {% endfor %}
                  {% else %}
                    <p class="muted">Sin imagenes de referencia.</p>
                  {% endif %}
                </div>
              {% endfor %}
            {% else %}
              <p class="muted">Sin versiones.</p>
            {% endif %}
          </div>
        </article>
      {% endfor %}
    </div>
  {% else %}
    <p class="muted">No hay anclas en esta saga.</p>
  {% endif %}
</section>
{% endblock %}
