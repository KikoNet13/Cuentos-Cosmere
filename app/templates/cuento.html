{% extends "base.html" %}
{% block title %}{{ story.title }}{% endblock %}
{% block content %}
<nav class="breadcrumbs">
  {% for crumb in breadcrumbs %}
    {% if loop.last %}
      <span>{{ crumb.name }}</span>
    {% else %}
      <a href="{{ url_for('web.dashboard') if crumb.path == '' else url_for('web.node_detail', node_path=crumb.path) }}">{{ crumb.name }}</a>
      <span>/</span>
    {% endif %}
  {% endfor %}
</nav>

<section class="panel">
  <h1>{{ story.title }}</h1>
  <p class="muted">Ruta del cuento: <code>{{ story.story_rel_path }}</code></p>
  <p class="muted">Estado: {{ story.status }}</p>

  {% if page_numbers %}
    <div class="row gap center wrap">
      {% if prev_page %}
        <a class="inline-link" href="{{ url_for('web.story_detail', story_path=story.story_rel_path, p=prev_page) }}">&larr; Página {{ prev_page }}</a>
      {% endif %}

      <form method="get" action="{{ url_for('web.story_detail', story_path=story.story_rel_path) }}" class="inline-form">
        <label>Página
          <select name="p" onchange="this.form.submit()">
            {% for num in page_numbers %}
              <option value="{{ num }}" {% if num == selected_page %}selected{% endif %}>{{ num }}</option>
            {% endfor %}
          </select>
        </label>
      </form>

      {% if next_page %}
        <a class="inline-link" href="{{ url_for('web.story_detail', story_path=story.story_rel_path, p=next_page) }}">Página {{ next_page }} &rarr;</a>
      {% endif %}
    </div>
  {% else %}
    <p class="muted">No hay páginas indexadas en caché para este cuento.</p>
  {% endif %}

  {% if missing_pages %}
    <p class="warn">Faltan páginas en secuencia: {{ missing_pages | join(', ') }}</p>
  {% endif %}
</section>

{% if page %}
<section class="panel">
  <h2>Texto de página {{ page.page_number }}</h2>
  <pre id="page-text">{{ page.content }}</pre>
  <div class="row gap top-gap">
    <button type="button" onclick="copyTextFromElement('page-text','copy-page-text')">Copiar texto</button>
    <span id="copy-page-text" class="copy-feedback"></span>
  </div>
</section>

<section class="panel">
  <h2>Prompts e imágenes de página {{ page.page_number }}</h2>
  {% if slots %}
    <div class="cards">
      {% for slot in slots %}
        <article class="card">
          <div class="card-head">
            <div>
              <strong>Slot: {{ slot.slot_name }}</strong>
              <span class="chip">{{ slot.role }}</span>
            </div>
            <small class="muted">Orden {{ slot.display_order }}</small>
          </div>

          <div class="card-body">
            <p><strong>Ruta de imagen:</strong> <code>{{ slot.image_rel_path }}</code></p>

            {% if slot.image_exists %}
              <img src="{{ slot.image_url }}" alt="{{ slot.slot_name }}">
              <div class="row gap wrap">
                <button type="button" onclick="copyImageFromUrl('{{ slot.image_url }}','copy-slot-image-{{ loop.index }}')">Copiar imagen al portapapeles</button>
                <span id="copy-slot-image-{{ loop.index }}" class="copy-feedback"></span>
              </div>
            {% else %}
              <p class="warn">No hay imagen guardada para este slot.</p>
            {% endif %}

            <h4>Prompt</h4>
            <pre id="prompt-{{ loop.index }}">{{ slot.prompt_text }}</pre>
            <div class="row gap top-gap wrap">
              <button type="button" onclick="copyTextFromElement('prompt-{{ loop.index }}','copy-prompt-{{ loop.index }}')">Copiar prompt</button>
              <span id="copy-prompt-{{ loop.index }}" class="copy-feedback"></span>
            </div>

            <h4>Requisitos</h4>
            {% if slot.requirements %}
              {% for req in slot.requirements %}
                <div class="item-card">
                  <p><strong>{{ req.kind }}</strong> <code>{{ req.ref }}</code></p>

                  {% if req.refs %}
                    {% for ref in req.refs %}
                      <p><code>{{ ref.rel_path }}</code></p>
                      {% if ref.exists %}
                        <img src="{{ ref.url }}" alt="{{ ref.rel_path }}">
                        <div class="row gap wrap">
                          <button type="button" onclick="copyImageFromUrl('{{ ref.url }}','copy-req-{{ loop.index }}-{{ loop.index0 }}')">Copiar imagen</button>
                          <span id="copy-req-{{ loop.index }}-{{ loop.index0 }}" class="copy-feedback"></span>
                        </div>
                      {% else %}
                        <p class="warn">Referencia no encontrada en disco.</p>
                      {% endif %}
                    {% endfor %}
                  {% else %}
                    <p class="muted">Sin referencias visuales resolubles.</p>
                  {% endif %}
                </div>
              {% endfor %}
            {% else %}
              <p class="muted">Sin requisitos para este slot.</p>
            {% endif %}

            <h4>Guardar imagen generada</h4>
            <form method="post" action="{{ url_for('web.upload_slot_image', story_path=story.story_rel_path, page_number=page.page_number, slot_name=slot.slot_name) }}" enctype="multipart/form-data" class="form-grid">
              <label>Subir archivo
                <input type="file" name="image_file" accept="image/png,image/jpeg,image/webp">
              </label>
              <label class="full">Pegar desde portapapeles
                <div class="row gap wrap">
                  <button type="button" class="secondary" onclick="pasteImageToHidden('pasted-{{ loop.index }}','paste-feedback-{{ loop.index }}')">Pegar imagen</button>
                  <span id="paste-feedback-{{ loop.index }}" class="copy-feedback"></span>
                </div>
              </label>
              <input id="pasted-{{ loop.index }}" type="hidden" name="pasted_image_data" value="">

              {% if cache_status and cache_status.stale %}
                <p class="warn full">Primero actualiza caché para habilitar el guardado.</p>
              {% endif %}

              <button type="submit" {% if cache_status and cache_status.stale %}disabled{% endif %}>Guardar imagen del slot</button>
            </form>
          </div>
        </article>
      {% endfor %}
    </div>
  {% else %}
    <p class="muted">Esta página no define slots de imagen en su frontmatter.</p>
  {% endif %}
</section>
{% endif %}
{% endblock %}