<article class="box editor-slot-card">
  <div class="is-flex is-justify-content-space-between is-align-items-center is-flex-wrap-wrap gap-2 mb-3">
    <h3 class="title is-6 mb-0">Slot {{ slot.slot_name }}</h3>
    <span class="tag is-rounded">Estado: {{ slot.status }}</span>
  </div>

  <p class="panel-label">Prompt</p>
  <pre id="editor-prompt-{{ slot_index }}" class="story-prose">{{ slot.prompt }}</pre>
  <div class="is-flex is-align-items-center gap-2 mt-2">
    <button class="button is-small is-light" type="button" onclick="copyTextFromElement('editor-prompt-{{ slot_index }}','copy-editor-prompt-{{ slot_index }}')">Copiar prompt</button>
    <span id="copy-editor-prompt-{{ slot_index }}" class="copy-feedback"></span>
  </div>

  <p class="panel-label mt-4">Referencias del prompt</p>
  {% if slot.reference_assets %}
    <div class="advanced-alt-grid">
      {% for ref in slot.reference_assets %}
        {% set ref_index = loop.index %}
        <article class="alt-card">
          <p class="is-size-7 mb-1"><strong>Archivo:</strong> <code>{{ ref.filename }}</code></p>
          {% if ref.found %}
            <p class="is-size-7 mb-2"><strong>Nodo:</strong> <code>{{ ref.node_rel_path or 'library' }}</code></p>
            <img src="{{ ref.image_url }}" alt="Referencia {{ ref.filename }}">
            <div class="is-flex is-align-items-center gap-2 mt-2">
              <button class="button is-small is-light" type="button" onclick="copyImageFromUrl('{{ ref.image_url }}','copy-editor-ref-{{ slot_index }}-{{ ref_index }}')">Copiar imagen</button>
              <span id="copy-editor-ref-{{ slot_index }}-{{ ref_index }}" class="copy-feedback"></span>
            </div>
          {% else %}
            <p class="has-text-danger is-size-7">Referencia no encontrada.</p>
          {% endif %}
        </article>
      {% endfor %}
    </div>
  {% else %}
    <p class="has-text-grey is-size-7">Sin reference_ids en este slot.</p>
  {% endif %}

  {% if slot.active_item and slot.active_item.image_exists %}
    <p class="panel-label mt-4">Imagen activa</p>
    <img class="editor-slot-image" src="{{ slot.active_item.image_url }}" alt="Imagen activa {{ slot.slot_name }}">
    <div class="is-flex is-align-items-center gap-2 mt-2">
      <button class="button is-small is-light" type="button" onclick="copyImageFromUrl('{{ slot.active_item.image_url }}','copy-editor-active-{{ slot_index }}')">Copiar imagen activa</button>
      <span id="copy-editor-active-{{ slot_index }}" class="copy-feedback"></span>
    </div>
  {% else %}
    <p class="has-text-grey is-size-7 mt-4">Sin imagen activa disponible.</p>
  {% endif %}

  <p class="panel-label mt-4">Alternativas</p>
  {% if slot.alternatives %}
    <div class="advanced-alt-grid">
      {% for alternative in slot.alternatives %}
        {% set alternative_index = loop.index %}
        <article class="alt-card {% if alternative.is_active %}is-active{% endif %}">
          <p class="is-size-7 mb-1"><strong>ID:</strong> <code>{{ alternative.id }}</code></p>
          <p class="is-size-7 mb-2"><strong>Slug:</strong> {{ alternative.slug }}</p>

          {% if alternative.image_exists %}
            <img src="{{ alternative.image_url }}" alt="Alternativa {{ alternative.id }}">
            <div class="is-flex is-align-items-center gap-2 mt-2">
              <button
                class="button is-small is-light"
                type="button"
                onclick="copyImageFromUrl('{{ alternative.image_url }}','copy-editor-alt-{{ slot_index }}-{{ alternative_index }}')"
              >Copiar imagen</button>
              <span id="copy-editor-alt-{{ slot_index }}-{{ alternative_index }}" class="copy-feedback"></span>
            </div>
          {% else %}
            <p class="has-text-grey is-size-7">Archivo no encontrado.</p>
          {% endif %}

          {% if alternative.is_active %}
            <span class="tag is-success is-light mt-3">Activa</span>
          {% else %}
            <form method="post" action="{{ url_for('web.activate_slot_image', story_path=story.story_rel_path, slot_name=slot.slot_name, p=page.page_number) }}" class="mt-3">
              <input type="hidden" name="next" value="{{ request.full_path }}">
              <input type="hidden" name="alternative_id" value="{{ alternative.id }}">
              <button class="button is-small is-primary is-light" type="submit">Usar como activa</button>
            </form>
          {% endif %}
        </article>
      {% endfor %}
    </div>
  {% else %}
    <p class="has-text-grey is-size-7">Sin alternativas registradas.</p>
  {% endif %}

  <hr>
  <h4 class="title is-6">Subir alternativa</h4>
  <form
    method="post"
    action="{{ url_for('web.upload_slot_image', story_path=story.story_rel_path, slot_name=slot.slot_name, p=page.page_number) }}"
    enctype="multipart/form-data"
    class="is-flex is-flex-direction-column gap-2"
  >
    <input type="hidden" name="next" value="{{ request.full_path }}">

    <div>
      <label class="label is-size-7">Archivo</label>
      <input class="input is-small" type="file" name="image_file" accept="image/png,image/jpeg,image/webp,image/gif">
    </div>
    <div>
      <label class="label is-size-7">Slug</label>
      <input class="input is-small" type="text" name="alt_slug" placeholder="{{ slot.slot_name }}-editorial">
    </div>
    <div>
      <label class="label is-size-7">Notas</label>
      <textarea class="textarea is-small" name="alt_notes" rows="2" placeholder="Observaciones editoriales"></textarea>
    </div>

    <div>
      <label class="label is-size-7">Pegar desde portapapeles</label>
      <div class="is-flex is-align-items-center gap-2">
        <button
          class="button is-small is-light"
          type="button"
          onclick="pasteImageToHidden('pasted-editor-{{ slot.slot_name }}-{{ slot_index }}','paste-feedback-editor-{{ slot.slot_name }}-{{ slot_index }}')"
        >Pegar imagen</button>
        <span id="paste-feedback-editor-{{ slot.slot_name }}-{{ slot_index }}" class="copy-feedback"></span>
      </div>
      <input id="pasted-editor-{{ slot.slot_name }}-{{ slot_index }}" type="hidden" name="pasted_image_data" value="">
    </div>

    <button class="button is-small is-link is-light" type="submit">Agregar alternativa</button>
  </form>
</article>
