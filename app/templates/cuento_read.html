{% extends "base.html" %}
{% block title %}{{ story.title }}{% endblock %}
{% block content %}
<nav class="breadcrumbs">
  {% for crumb in breadcrumbs %}
    {% if loop.last %}
      <span>{{ crumb.name }}</span>
    {% else %}
      <a href="{{ url_for('web.dashboard') if crumb.path == '' else url_for('web.node_detail', node_path=crumb.path) }}">{{ crumb.name }}</a>
      <span>/</span>
    {% endif %}
  {% endfor %}
</nav>

<section class="panel">
  <div class="row between center wrap">
    <div>
      <h1>{{ story.title }}</h1>
      <p class="muted">Ruta del cuento: <code>{{ story.story_rel_path }}</code></p>
      <p class="muted">Estado: {{ story.status }}</p>
    </div>
    <a class="inline-link subtle-toggle" href="{{ url_for('web.story_detail', story_path=story.story_rel_path, p=selected_page, editor=1) }}">Modo editorial</a>
  </div>

  {% if page_numbers %}
    <div class="row gap center wrap">
      {% if prev_page %}
        <a class="inline-link" href="{{ url_for('web.story_detail', story_path=story.story_rel_path, p=prev_page) }}">&larr; Página {{ prev_page }}</a>
      {% endif %}

      <form method="get" action="{{ url_for('web.story_detail', story_path=story.story_rel_path) }}" class="inline-form">
        <label>Página
          <select name="p" onchange="this.form.submit()">
            {% for num in page_numbers %}
              <option value="{{ num }}" {% if num == selected_page %}selected{% endif %}>{{ num }}</option>
            {% endfor %}
          </select>
        </label>
      </form>

      {% if next_page %}
        <a class="inline-link" href="{{ url_for('web.story_detail', story_path=story.story_rel_path, p=next_page) }}">Página {{ next_page }} &rarr;</a>
      {% endif %}
    </div>
  {% endif %}

  {% if missing_pages %}
    <p class="warn">Faltan páginas en secuencia: {{ missing_pages | join(', ') }}</p>
  {% endif %}
</section>

{% if page %}
  {% set main_slot = (slots | selectattr('slot_name', 'equalto', 'main') | list | first) %}

  <section class="panel">
    <h2>Página {{ page.page_number }}</h2>
    <pre>{{ page.text_current }}</pre>
  </section>

  <section class="panel">
    <h2>Ilustración principal</h2>
    {% if main_slot and main_slot.active_item and main_slot.active_item.image_exists %}
      <img class="reader-image" src="{{ main_slot.active_item.image_url }}" alt="Imagen principal página {{ page.page_number }}">
    {% elif main_slot and main_slot.alternatives and (main_slot.alternatives | first).image_exists %}
      <img class="reader-image" src="{{ (main_slot.alternatives | first).image_url }}" alt="Imagen alternativa página {{ page.page_number }}">
    {% else %}
      <p class="muted">Sin imagen activa disponible para esta página.</p>
    {% endif %}
  </section>
{% endif %}
{% endblock %}
